name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  quality-checks:
    name: Code Quality and Tests
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode.app
      
    - name: Install SwiftLint
      run: brew install swiftlint
      
    - name: Run SwiftLint
      continue-on-error: true
      run: swiftlint lint --reporter github-actions-logging
      
    - name: Build
      run: swift build -v
      
    - name: Run tests
      run: swift test -v --enable-code-coverage
      
    - name: Convert coverage data
      run: |
        xcrun llvm-cov export -format="lcov" \
          .build/debug/AIHedgeFundPackageTests.xctest/Contents/MacOS/AIHedgeFundPackageTests \
          -instr-profile .build/debug/codecov/default.profdata \
          -ignore-filename-regex="(.build|Tests)" \
          > coverage.lcov
          
    - name: Generate HTML Coverage Report
      run: |
        brew install lcov
        genhtml coverage.lcov --output-directory docs/coverage_report
        
    - name: Upload Pages Artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: docs
        
  deploy-pages:
    needs: quality-checks
    if: github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
